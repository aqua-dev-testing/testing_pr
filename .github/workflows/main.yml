name: Aqua - Reproduce Default Branch Issue
on:
  push:
    branches:
      - main

jobs:
  aqua:
    name: Aqua scanner (Reproduce Issue)
    runs-on: ubuntu-latest
    steps:
      # STEP 1: Checkout repo (creates .git so Trivy can attempt branch detection)
      - name: Checkout code
        uses: actions/checkout@v2

      # STEP 2: BREAK GIT AUTH (simulate customer's authentication failure)
      - name: Break default branch detection (simulate customer error)
        run: |
          echo "Simulating failed 'git remote show origin'..."
          git remote set-url origin https://integration.shared-services-prd.aws.cld.cma-cgm.com/gitlab/not-accessible/repo.git
          git config credential.helper "!f() { echo 'auth broken'; return 1; }; f"
          unset GITHUB_TOKEN || true

      # STEP 3: Run Aqua scanner WITHOUT OVERRIDE_DEFAULT_BRANCH
      - name: Run Aqua scanner (no override)
        uses: docker://aquasec/aqua-scanner
        with:
          args: trivy fs --scanners vuln,misconfig,secret .
        env:
          AQUA_KEY: ${{ secrets.AQUA_KEY }}
          AQUA_SECRET: ${{ secrets.AQUA_SECRET }}
          GITHUB_TOKEN: ${{ github.token }}
          AQUA_URL: https://api.dev.supply-chain.cloud.aquasec.com
          CSPM_URL: https://stage.api.cloudsploit.com
          TRIVY_RUN_AS_PLUGIN: "aqua"
          # ‚ùó NO OVERRIDE_DEFAULT_BRANCH HERE
